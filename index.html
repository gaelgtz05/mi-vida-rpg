<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Vida RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-color: #0d1117; --main-color: #161b22; --border-color: #30363d;
            --text-color: #c9d1d9; --text-accent-color: #f0f6fc; --accent-color: #388bfd;
            --xp-color: #388bfd; --success-color: #238636; --danger-color: #da3633;
            --warning-color: #f5a623;
            --nav-height: 70px; /* Altura de la barra de navegación inferior */
        }
        body { 
            font-family: 'Press Start 2P', cursive; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            text-shadow: 2px 2px #00000060; 
            image-rendering: pixelated; 
            padding-bottom: var(--nav-height); /* Espacio para la barra de navegación */
        }
        .pixel-box { background-color: var(--main-color); border: 4px solid var(--border-color); box-shadow: 6px 6px 0px #000000; padding: 1.5rem; }
        .pixel-button { background-color: var(--accent-color); border: 4px solid var(--border-color); box-shadow: 4px 4px 0px #000000; padding: 0.75rem 1rem; color: var(--text-accent-color); text-transform: uppercase; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; }
        .pixel-button:hover { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #000000; }
        .pixel-button.green { background-color: var(--success-color); } .pixel-button.red { background-color: var(--danger-color); }
        .pixel-button.yellow { background-color: var(--warning-color); color: #000; } .pixel-button.gray { background-color: #484f58; }
        input, textarea { font-family: 'Press Start 2P', cursive; background-color: var(--bg-color); border: 4px solid var(--border-color); padding: 0.75rem; color: var(--text-color); width: 100%; }
        input:focus, textarea:focus { outline: none; border-color: var(--accent-color); }
        .progress-bar-container { background-color: var(--bg-color); border: 2px solid var(--border-color); padding: 4px; }
        .progress-bar { height: 20px; }
        .modal-backdrop { background-color: rgba(0,0,0,0.8); transition: opacity 0.2s; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        ::-webkit-scrollbar { width: 16px; } ::-webkit-scrollbar-track { background: var(--bg-color); border-left: 4px solid var(--border-color); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border: 4px solid var(--main-color); }
        .pixel-checkbox { appearance: none; width: 24px; height: 24px; background-color: var(--bg-color); border: 3px solid var(--border-color); cursor: pointer; position: relative; margin-right: 0.75rem; flex-shrink: 0; }
        .pixel-checkbox:checked { background-color: var(--accent-color); border-color: var(--text-accent-color); }
        .pixel-checkbox:checked::after { content: 'X'; color: var(--text-accent-color); position: absolute; font-size: 14px; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .carousel-wrapper { position: relative; }
        .carousel-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .carousel-container::-webkit-scrollbar { display: none; }
        .carousel-slide { flex: 0 0 80%; scroll-snap-align: center; margin: 0 10px; }
        @media (min-width: 768px) { .carousel-slide { flex-basis: 40%; } } @media (min-width: 1024px) { .carousel-slide { flex-basis: 30%; } }
        .carousel-nav { display: none; position: absolute; top: 40%; transform: translateY(-50%); width: 100%; justify-content: space-between; pointer-events: none; }
        @media (min-width: 768px) { .carousel-nav { display: flex; } }
        .nav-arrow { pointer-events: all; background-color: rgba(22, 27, 34, 0.7); border: 2px solid var(--border-color); border-radius: 50%; padding: 0.5rem; }
        .item-image { width: 100%; height: 180px; object-fit: contain; background-color: transparent; border: none; transition: filter 0.3s ease-in-out; }
        .item-image.locked { filter: grayscale(1) opacity(0.5); }
        .lock-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; color: var(--text-accent-color); text-shadow: 3px 3px 0px #000; pointer-events: none; }
        input[type="file"] { border: none; padding: 0; }
        input[type="file"]::file-selector-button { font-family: 'Press Start 2P'; background-color: var(--accent-color); border: 2px solid var(--border-color); padding: 0.5rem; color: var(--text-accent-color); cursor: pointer; }
        .item-card-minimal { display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; padding: 1rem 0; }
        .item-card-minimal .item-name { margin-top: 0.5rem; font-size: 0.9rem; }
        .item-card-minimal .item-price { font-size: 0.8rem; }
        .financial-tag { font-size: 0.6rem; padding: 2px 6px; border: 2px solid; margin-bottom: 0.5rem; }
        
        /* --- ESTILOS PARA EL PERSONAJE CUADRADO --- */
        #character-avatar {
            width: 80px;
            height: 80px;
            border-radius: 0; /* Cambio a cuadrado */
            border: 4px solid var(--border-color);
            object-fit: cover;
            background-color: var(--bg-color);
            cursor: pointer;
            transition: transform 0.2s;
            image-rendering: pixelated;
        }
        #character-avatar:hover {
            transform: scale(1.1);
        }

        /* --- ESTILOS PARA LA NUEVA BARRA DE NAVEGACIÓN INFERIOR --- */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background-color: var(--main-color);
            border-top: 4px solid var(--border-color);
            box-shadow: 0 -6px 0px #000000;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 8px;
            z-index: 1000;
        }
        .nav-icon-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            font-size: 0.65rem; /* Texto pequeño para el icono */
            cursor: pointer;
            padding: 5px 0;
            gap: 2px;
            transition: color 0.2s, transform 0.1s;
            text-shadow: none; /* Quitar sombra al texto del icono */
        }
        .nav-icon-button.active {
            color: var(--accent-color);
        }
        .nav-icon-button:hover {
            transform: translateY(-2px);
            color: var(--text-accent-color);
        }
        .nav-icon-button i {
            width: 24px;
            height: 24px;
            stroke-width: 2.5; /* Más grueso para visibilidad */
        }
        .nav-icon-button.active i {
             stroke: var(--accent-color);
        }

        /* Ajuste para el contenido principal para que no quede debajo de la nav bar */
        main {
            padding-bottom: 20px; /* Para que el último contenido no toque la barra de nav */
        }

        /* Ocultar los botones de tab antiguos */
        .old-tab-buttons {
            display: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <audio id="background-music" loop></audio>
    <audio id="sfx-player"></audio>

    <div class="container mx-auto max-w-5xl">
        <header class="pixel-box mb-8">
            <h1 class="text-2xl md:text-3xl text-text-accent-color text-center mb-4">MI VIDA RPG</h1>
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex items-center gap-4">
                    <label for="avatar-upload" class="cursor-pointer">
                        <img id="character-avatar" src="https://placehold.co/80x80/161b22/c9d1d9?text=?" alt="Avatar">
                    </label>
                    <input type="file" id="avatar-upload" class="hidden" accept="image/png, image/jpeg">
                    <div>
                        <h2 id="character-username" class="text-xl md:text-2xl text-text-accent-color">elgatin</h2>
                        <p class="text-sm text-gray-500">Organizador Personal</p>
                    </div>
                </div>

                <div class="w-full md:w-1/2 space-y-3">
                    <div class="flex items-center gap-2 text-sm"><span class="text-blue-400">PROGRESO:</span><div class="progress-bar-container w-full"><div id="xp-bar" class="progress-bar bg-blue-500"></div></div><span id="xp-text">0%</span></div>
                    <div class="flex items-center gap-2 text-sm"><span class="text-green-400">SALDO:</span><div id="player-balance" class="text-green-400 font-bold">$0.00</div></div>
                </div>
                 <button id="music-toggle-btn" class="pixel-button !p-2"><i data-lucide="volume-x"></i></button>
            </div>
        </header>

        <nav class="old-tab-buttons flex flex-wrap gap-2 mb-4">
            <button class="tab-button pixel-button sfx-click active" onclick="showTab('misiones')">Misiones</button>
            <button class="tab-button pixel-button sfx-click" onclick="showTab('finanzas')">Finanzas</button>
            <button class="tab-button pixel-button sfx-click" onclick="showTab('tienda')">Tienda</button>
            <button class="tab-button pixel-button sfx-click" onclick="showTab('inventario')">Inventario</button>
            <button class="tab-button pixel-button sfx-click" onclick="showTab('armario')">Armario</button>
            <button class="tab-button pixel-button sfx-click" onclick="showTab('ajustes')">Ajustes</button>
        </nav>

        <main>
            <div id="misiones-tab" class="tab-content active"><div class="pixel-box"><h2 class="text-xl mb-4 text-center text-text-accent-color">MISIONES DIARIAS</h2><div id="mission-list" class="space-y-4 mb-6 max-h-96 overflow-y-auto p-2"></div><div class="flex flex-col md:flex-row gap-4"><input type="text" id="new-mission-input" placeholder="Nueva misión..."><button class="pixel-button sfx-click" onclick="addMission()">Aceptar</button></div></div></div>
            <div id="finanzas-tab" class="tab-content"><div class="pixel-box"><h2 class="text-xl mb-4 text-center text-text-accent-color">LIBRO DE CUENTAS</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><button class="pixel-button green sfx-click" onclick="openModal('income-modal')">+ Ingreso</button><button class="pixel-button red sfx-click" onclick="openModal('expense-modal')">- Egreso</button></div><h3 class="text-lg mb-2">Historial:</h3><div id="transaction-list" class="space-y-3 text-sm max-h-80 overflow-y-auto border-2 border-dashed border-gray-600 p-2"></div></div></div>
            <div id="tienda-tab" class="tab-content"><div class="pixel-box"><h2 class="text-xl mb-4 text-center text-text-accent-color">TIENDA DE DESEOS</h2><div class="carousel-wrapper"><div id="store-carousel" class="carousel-container"></div><div class="carousel-nav"><button class="nav-arrow" onclick="slideStore(-1)"><i data-lucide="arrow-left"></i></button><button class="nav-arrow" onclick="slideStore(1)"><i data-lucide="arrow-right"></i></button></div></div><button class="pixel-button w-full mt-6 sfx-click" onclick="openModal('new-item-modal')">Añadir Objeto</button></div></div>
            <div id="inventario-tab" class="tab-content"><div class="pixel-box"><h2 class="text-xl mb-4 text-center text-text-accent-color">INVENTARIO</h2><div id="inventory-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-96 overflow-y-auto p-2"></div></div></div>
            <div id="armario-tab" class="tab-content"><div class="pixel-box"><h2 class="text-xl mb-6 text-center text-text-accent-color">GUARDARROPA</h2><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1"><h3 class="text-lg mb-4">Planificador</h3><div id="weekly-planner" class="space-y-3"></div></div><div class="lg:col-span-2"><h3 class="text-lg mb-4">Mi Inventario</h3><div id="wardrobe-inventory" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[400px] overflow-y-auto border-2 border-dashed border-gray-600 p-2"></div><button class="pixel-button w-full mt-4 sfx-click" onclick="openModal('add-clothing-modal')">Añadir Prenda</button></div></div></div></div>
            <div id="ajustes-tab" class="tab-content">
                <div class="pixel-box">
                    <h2 class="text-xl mb-6 text-center text-text-accent-color">AJUSTES DE SONIDO</h2>
                    <div class="space-y-6">
                        <div>
                            <label class="text-lg mb-2 block">Música de Fondo</label>
                            <p class="text-xs mb-3 opacity-70">Sube un archivo MP3 (máx 10MB) para cambiar la música.</p>
                            <input type="file" id="music-upload" accept="audio/mp3">
                            <p id="music-file-name" class="text-xs opacity-70 mt-2"></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="income-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50 hidden"><div class="pixel-box w-full max-w-md"><h3 class="text-lg mb-4">Registrar Ingreso</h3><input type="number" id="income-amount" placeholder="Monto ($)" class="mb-3"><input type="text" id="income-source" placeholder="Origen" class="mb-4"><div class="flex justify-end gap-3"><button class="pixel-button gray sfx-click" onclick="closeModal('income-modal')">Cerrar</button><button class="pixel-button green sfx-click" onclick="addTransaction('income')">Registrar</button></div></div></div>
    <div id="expense-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50 hidden"><div class="pixel-box w-full max-w-md"><h3 class="text-lg mb-4">Registrar Egreso</h3><input type="number" id="expense-amount" placeholder="Monto ($)" class="mb-3"><input type="text" id="expense-description" placeholder="Descripción" class="mb-4"><div class="flex justify-end gap-3"><button class="pixel-button gray sfx-click" onclick="closeModal('expense-modal')">Cerrar</button><button class="pixel-button red sfx-click" onclick="addTransaction('expense')">Registrar</button></div></div></div>
    <div id="new-item-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50 hidden"><div class="pixel-box w-full max-w-md"><h3 class="text-lg mb-4">Nuevo Objeto</h3><input type="text" id="item-name" placeholder="Nombre" class="mb-3"><input type="number" id="item-price" placeholder="Precio ($)" class="mb-3"><label class="text-sm mb-2 block">Imagen (PNG, JPG):</label><input type="file" id="item-image-upload" accept="image/png, image/jpeg" class="mb-4"><div class="flex justify-end gap-3"><button class="pixel-button gray sfx-click" onclick="closeModal('new-item-modal')">Cerrar</button><button class="pixel-button sfx-click" onclick="addStoreItem()">Añadir</button></div></div></div>
    <div id="confirm-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50 hidden"><div class="pixel-box w-full max-w-md text-center"><h3 id="confirm-title" class="text-lg mb-4"></h3><p id="confirm-message" class="mb-6"></p><div class="flex justify-center gap-4"><button id="confirm-cancel-btn" class="pixel-button gray sfx-click">Cancelar</button><button id="confirm-ok-btn" class="pixel-button sfx-click">Confirmar</button></div></div></div>
    <div id="add-clothing-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50 hidden"><div class="pixel-box w-full max-w-md"><h3 class="text-lg mb-4">Añadir Prenda</h3><input type="text" id="clothing-name" placeholder="Nombre" class="mb-3"><input type="text" id="clothing-url" placeholder="URL de imagen" class="mb-4"><div class="flex justify-end gap-3"><button class="pixel-button gray sfx-click" onclick="closeModal('add-clothing-modal')">Cerrar</button><button class="pixel-button sfx-click" onclick="addWardrobeItem()">Añadir</button></div></div></div>
    <div id="plan-outfit-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50 hidden"><div class="pixel-box w-full max-w-2xl"><h3 class="text-lg mb-4" id="plan-outfit-title">Planificar Outfit</h3><div id="plan-outfit-inventory" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4 max-h-80 overflow-y-auto border-2 border-dashed border-gray-600 p-2 mb-4"></div><div class="flex justify-end gap-3"><button class="pixel-button gray sfx-click" onclick="closeModal('plan-outfit-modal')">Cerrar</button></div></div></div>

    <nav id="bottom-nav">
        <button class="nav-icon-button sfx-click active" onclick="showTab('misiones')">
            <i data-lucide="clipboard-check"></i>
        </button>
        <button class="nav-icon-button sfx-click" onclick="showTab('finanzas')">
            <i data-lucide="wallet"></i>
        </button>
        <button class="nav-icon-button sfx-click" onclick="showTab('tienda')">
            <i data-lucide="shopping-bag"></i>
        </button>
        <button class="nav-icon-button sfx-click" onclick="showTab('inventario')">
            <i data-lucide="archive"></i>
        </button>
        <button class="nav-icon-button sfx-click" onclick="showTab('armario')">
            <i data-lucide="shirt"></i>
        </button>
        <button class="nav-icon-button sfx-click" onclick="showTab('ajustes')">
            <i data-lucide="settings"></i>
        </button>
    </nav>

<script>
let state = { 
    balance: 0, 
    missions: [], 
    transactions: [], 
    storeItems: [], 
    wardrobe: { clothes: [], outfits: {} },
    audio: { music: null, musicFileName: null },
    character: { 
        username: "elgatin",
        avatar: null
    }
};
const DOM = { 
    xpBar: document.getElementById('xp-bar'), xpText: document.getElementById('xp-text'), playerBalance: document.getElementById('player-balance'), missionList: document.getElementById('mission-list'), transactionList: document.getElementById('transaction-list'), storeCarousel: document.getElementById('store-carousel'), inventoryList: document.getElementById('inventory-list'), wardrobeInventory: document.getElementById('wardrobe-inventory'), weeklyPlanner: document.getElementById('weekly-planner'), 
    musicToggleBtn: document.getElementById('music-toggle-btn'), bgMusic: document.getElementById('background-music'), sfxPlayer: document.getElementById('sfx-player'), 
    confirmModal: { el: document.getElementById('confirm-modal'), title: document.getElementById('confirm-title'), message: document.getElementById('confirm-message'), okBtn: document.getElementById('confirm-ok-btn'), cancelBtn: document.getElementById('confirm-cancel-btn') },
    musicUpload: document.getElementById('music-upload'), musicFileName: document.getElementById('music-file-name'),
    characterAvatar: document.getElementById('character-avatar'),
    avatarUpload: document.getElementById('avatar-upload'),
    characterUsername: document.getElementById('character-username'),
    bottomNav: document.getElementById('bottom-nav') // Nuevo selector para la barra de navegación
};
const DEFAULT_MUSIC_URL = 'https://cdn.pixabay.com/download/audio/2022/11/22/audio_2c0d5257bf.mp3?filename=lofi-beat-126488.mp3';
const SFX_CLICK_URL = 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_23b3713a86.mp3?filename=select-sound-121244.mp3';
const INGRESOS = { SENCILLO: 350, AVANZADO: 550 };
const UMBRAL_COMPRA_GRANDE = 0.30;

function saveState() {
    try {
        localStorage.setItem('miVidaRpgState_v16', JSON.stringify(state)); // Versión incrementada
    } catch (e) {
        console.error("Error al guardar el estado. ¿Navegador en modo privado?", e);
    }
}
function loadState() { 
    const s = localStorage.getItem('miVidaRpgState_v16'); // Versión incrementada
    if(s) { 
        state = JSON.parse(s); 
        if (!state.audio) { state.audio = { music: null, musicFileName: null }; }
        if (!state.character) { state.character = { username: "elgatin", avatar: null }; } // Asegurar valores por defecto
    } 
}

function render() { renderCharacter(); renderStats(); renderMissions(); renderTransactions(); renderStore(); renderInventory(); renderWardrobe(); renderAjustes(); lucide.createIcons(); }

function renderCharacter() {
    DOM.characterUsername.textContent = state.character.username;
    if (state.character.avatar) {
        DOM.characterAvatar.src = state.character.avatar;
    } else {
        DOM.characterAvatar.src = "https://placehold.co/80x80/161b22/c9d1d9?text=?"; // Placeholder si no hay avatar
    }
}

function renderStats() { DOM.playerBalance.textContent = `$${state.balance.toFixed(2)}`; updateXpBar(); }
function updateXpBar() { const total = state.missions.length; const completed = state.missions.filter(m => m.completed).length; const perc = total === 0 ? 0 : Math.round((completed / total) * 100); DOM.xpBar.style.width = `${perc}%`; DOM.xpText.textContent = `${perc}%`; }

function renderStore() {
    const unpurchasedItems = state.storeItems.filter(item => !item.purchased);
    const lockSVG = `<svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>`;
    
    DOM.storeCarousel.innerHTML = unpurchasedItems.length === 0 ? '<p class="text-center opacity-50 w-full">¡Has comprado todo!</p>' : unpurchasedItems.map((item) => {
        const originalIndex = state.storeItems.findIndex(i => i.id === item.id);
        const imageUrl = item.imageData || `data:image/svg+xml,...`;
        let financialTag = '';
        if (item.price < INGRESOS.SENCILLO) { financialTag = `<span class="financial-tag" style="color: var(--success-color); border-color: var(--success-color);">Compra Fácil</span>`; }
        else if (item.price <= INGRESOS.AVANZADO) { financialTag = `<span class="financial-tag" style="color: var(--accent-color); border-color: var(--accent-color);">Meta Alcanzable</span>`; }
        else { financialTag = `<span class="financial-tag" style="color: var(--warning-color); border-color: var(--warning-color);">Gran Inversión</span>`; }
        return `<div class="carousel-slide item-card-minimal"><div class="relative w-full mb-2"><img src="${imageUrl}" alt="${item.name}" class="item-image locked"><div class="lock-overlay">${lockSVG}</div></div><h4 class="item-name text-text-accent-color truncate">${item.name}</h4><p class="item-price text-green-400 mb-2">$${item.price.toFixed(2)}</p>${financialTag}<button class="pixel-button sfx-click" onclick="confirmPurchase(${originalIndex})">Comprar</button></div>`;
    }).join('');
    DOM.storeCarousel.scrollLeft = 0;
}

function renderInventory() { const purchasedItems = state.storeItems.filter(item => item.purchased); DOM.inventoryList.innerHTML = purchasedItems.length === 0 ? '<p class="text-center opacity-50 col-span-full">Aún no tienes objetos.</p>' : purchasedItems.map(item => `<div class="item-card-minimal"><img src="${item.imageData}" alt="${item.name}" class="item-image mb-2"><h4 class="item-name text-text-accent-color truncate">${item.name}</h4></div>`).join(''); }

function renderAjustes() {
    DOM.musicFileName.textContent = state.audio.musicFileName ? `Cargado: ${state.audio.musicFileName}` : 'Usando música predeterminada.';
}

function playSound(soundUrl) { try { DOM.sfxPlayer.src = soundUrl; DOM.sfxPlayer.play(); } catch(e) {} }
function updateMusicSource() { 
    DOM.bgMusic.src = state.audio.music || DEFAULT_MUSIC_URL; 
    DOM.bgMusic.loop = true;
}
function toggleMusic() {
    const icon = DOM.musicToggleBtn.querySelector('i');
    if (DOM.bgMusic.paused) {
        DOM.bgMusic.play().then(() => {
            icon.setAttribute('data-lucide', 'volume-2');
            lucide.createIcons();
        }).catch(e => console.log("El usuario debe interactuar para iniciar la música."));
    } else {
        DOM.bgMusic.pause();
        icon.setAttribute('data-lucide', 'volume-x');
        lucide.createIcons();
    }
}
function handleFileUpload(file, callback) {
    if (!file) return;
    if (file.size > 10 * 1024 * 1024) { 
        alert("Error: Archivo muy grande (máx 10MB)");
        return;
    }
    const reader = new FileReader();
    reader.onload = (e) => { callback(e.target.result); };
    reader.readAsDataURL(file);
}

window.addMission = function() { const i = document.getElementById('new-mission-input'); const t = i.value.trim(); if (t) { state.missions.push({ text: t, completed: false }); i.value = ''; saveState(); render(); } }
window.toggleMission = function(index) { state.missions[index].completed = !state.missions[index].completed; saveState(); render(); }
window.addTransaction = function(type) { const aEl = document.getElementById(`${type}-amount`); const dEl = type === 'income' ? document.getElementById('income-source') : document.getElementById('expense-description'); const a = parseFloat(aEl.value); const d = dEl.value.trim(); if (!a || a <= 0 || !d) return; if (type === 'expense' && a > state.balance) return; state.balance += type === 'income' ? a : -a; state.transactions.push({ type, amount: a, description: d, date: new Date().toLocaleDateString('es-MX') }); aEl.value = ''; dEl.value = ''; closeModal('income-modal'); saveState(); render(); }
window.addStoreItem = function() { const nEl=document.getElementById('item-name'), pEl=document.getElementById('item-price'), iEl=document.getElementById('item-image-upload'); const n=nEl.value.trim(), p=parseFloat(pEl.value), f=iEl.files[0]; if(!n||!p||p<=0)return; const process=(d)=>{state.storeItems.push({id:`item_${Date.now()}`,name:n,price:p,imageData:d,purchased:false});nEl.value='';pEl.value='';iEl.value='';closeModal('new-item-modal');saveState();render();}; if(f){const r=new FileReader();r.onload=(e)=>process(e.target.result);r.readAsDataURL(f);}else{process(null);} }
window.confirmPurchase = function(index) {
    const item = state.storeItems[index];
    if (item.purchased || state.balance < item.price) return;
    const isRisky = item.price > (state.balance * UMBRAL_COMPRA_GRANDE);
    let title = 'Confirmar Compra', message = `¿Seguro que quieres comprar "${item.name}"?`, btnClass = 'green';
    if (isRisky) { title = '¡Compra Grande!'; message = `¡Cuidado! Usarás más del ${UMBRAL_COMPRA_GRANDE*100}% de tu saldo. ¿Seguro?`; btnClass = 'yellow'; }
    showConfirmation(title, message, btnClass, () => buyStoreItem(index));
}
function buyStoreItem(index) { const item=state.storeItems[index]; state.balance-=item.price; item.purchased=true; saveState(); render(); }
function showConfirmation(title, message, btnClass, callback) {
    DOM.confirmModal.title.textContent = title; DOM.confirmModal.message.textContent = message;
    DOM.confirmModal.okBtn.className = `pixel-button ${btnClass} sfx-click`;
    const newOkBtn = DOM.confirmModal.okBtn.cloneNode(true);
    DOM.confirmModal.okBtn.parentNode.replaceChild(newOkBtn, DOM.confirmModal.okBtn);
    DOM.confirmModal.okBtn = newOkBtn;
    DOM.confirmModal.okBtn.addEventListener('click', () => { callback(); closeModal('confirm-modal'); });
    DOM.confirmModal.cancelBtn.onclick = () => closeModal('confirm-modal');
    openModal('confirm-modal');
}
window.showTab = function(tabId) { 
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active')); 
    document.querySelectorAll('.nav-icon-button').forEach(b=>b.classList.remove('active')); // Desactivar todos los iconos
    
    document.getElementById(`${tabId}-tab`).classList.add('active'); 
    
    // Activar el icono correspondiente en la barra inferior
    const targetButton = DOM.bottomNav.querySelector(`[onclick="showTab('${tabId}')"]`);
    if (targetButton) {
        targetButton.classList.add('active');
    }
}
window.openModal = function(id) { document.getElementById(id).classList.remove('hidden'); }
window.closeModal = function(id) { document.getElementById(id).classList.add('hidden'); }
window.slideStore = function(dir) { const c=DOM.storeCarousel; const slide=c.querySelector('.carousel-slide'); if(!slide) return; const scrollAmount=slide.offsetWidth+20; c.scrollBy({left:scrollAmount*dir,behavior:'smooth'}); }
window.renderMissions = function() { DOM.missionList.innerHTML = state.missions.length === 0 ? '<p class="text-center opacity-50">No hay misiones.</p>' : state.missions.map((m, i) => `<div class="p-3 border-2 ${m.completed ? 'border-gray-600 opacity-50' : 'border-gray-400'} flex items-center"><input type="checkbox" id="mission-${i}" class="pixel-checkbox" onchange="toggleMission(${i})" ${m.completed ? 'checked' : ''}><label for="mission-${i}" class="${m.completed ? 'line-through' : ''}">${m.text}</label></div>`).join(''); }
window.renderTransactions = function() { DOM.transactionList.innerHTML = state.transactions.length === 0 ? '<p class="text-center opacity-50">Sin transacciones.</p>' : [...state.transactions].reverse().map(tx => `<div class="p-2 border-b-2 border-dashed border-gray-700"><div class="flex justify-between items-center"><span>${tx.description}</span><span class="font-bold ${tx.type === 'income' ? 'text-green-400' : 'text-red-400'}">${tx.type === 'income' ? '+' : '-'}$${tx.amount.toFixed(2)}</span></div><div class="text-xs opacity-60 text-right">${tx.date}</div></div>`).join(''); }
window.renderWardrobe = function() {
    DOM.wardrobeInventory.innerHTML = state.wardrobe.clothes.length === 0 ? '<p class="col-span-full text-center opacity-50">No hay prendas en tu armario.</p>' : state.wardrobe.clothes.map(item => `
        <div class="pixel-box p-2 relative flex flex-col items-center">
            <img src="${item.url}" alt="${item.name}" class="w-16 h-16 object-cover mb-2 pixelated">
            <span class="text-xs text-center truncate w-full">${item.name}</span>
            <button class="absolute top-1 right-1 text-red-400 hover:text-red-600 sfx-click" onclick="removeWardrobeItem('${item.id}')">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    `).join('');

    const days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
    DOM.weeklyPlanner.innerHTML = days.map(day => `
        <div class="border-b-2 border-gray-700 pb-3 mb-3 last:border-b-0">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-lg text-text-accent-color">${day}</h4>
                <div class="flex gap-2">
                    ${state.wardrobe.outfits[day] && state.wardrobe.outfits[day].length > 0 ? `<button class="pixel-button red yellow !py-1 !px-2 sfx-click" onclick="clearOutfit('${day}')">Quitar</button>` : ''}
                    <button class="pixel-button !py-1 !px-2 sfx-click" onclick="openOutfitPlanner('${day}')">Planificar</button>
                </div>
            </div>
            <div id="outfit-${day}" class="flex flex-wrap gap-2 min-h-[50px] bg-gray-900 p-2 rounded">
                ${state.wardrobe.outfits[day] && state.wardrobe.outfits[day].length > 0 ? state.wardrobe.outfits[day].map(itemId => {
                    const item = state.wardrobe.clothes.find(c => c.id === itemId);
                    return item ? `<img src="${item.url}" alt="${item.name}" class="w-10 h-10 object-cover pixelated border border-gray-600" title="${item.name}">` : '';
                }).join('') : '<span class="text-xs opacity-50">No hay outfit planeado.</span>'}
            </div>
        </div>
    `).join('');
}

window.addWardrobeItem = function() {
    const nameEl = document.getElementById('clothing-name');
    const urlEl = document.getElementById('clothing-url');
    const name = nameEl.value.trim();
    const url = urlEl.value.trim();

    if (!name || !url) {
        alert("Por favor, introduce un nombre y una URL para la prenda.");
        return;
    }

    state.wardrobe.clothes.push({ id: `clothing_${Date.now()}`, name: name, url: url });
    nameEl.value = '';
    urlEl.value = '';
    closeModal('add-clothing-modal');
    saveState();
    renderWardrobe();
}

window.removeWardrobeItem = function(id) {
    state.wardrobe.clothes = state.wardrobe.clothes.filter(item => item.id !== id);
    // También quitarlo de cualquier outfit planeado
    for (const day in state.wardrobe.outfits) {
        state.wardrobe.outfits[day] = state.wardrobe.outfits[day].filter(itemId => itemId !== id);
    }
    saveState();
    renderWardrobe();
}

let currentPlanningDay = null; // Variable para almacenar el día que se está planificando
window.openOutfitPlanner = function(day) {
    currentPlanningDay = day;
    document.getElementById('plan-outfit-title').textContent = `Planificar Outfit para ${day}`;
    const plannerInventory = document.getElementById('plan-outfit-inventory');
    
    plannerInventory.innerHTML = state.wardrobe.clothes.map(item => {
        const isSelected = state.wardrobe.outfits[day] && state.wardrobe.outfits[day].includes(item.id);
        return `
            <div class="flex flex-col items-center p-1 border-2 ${isSelected ? 'border-accent-color' : 'border-transparent'} bg-gray-800 cursor-pointer sfx-click"
                 onclick="toggleOutfitItem('${day}', '${item.id}')">
                <img src="${item.url}" alt="${item.name}" class="w-16 h-16 object-cover pixelated">
                <span class="text-xs text-center mt-1 truncate w-full">${item.name}</span>
            </div>
        `;
    }).join('');
    openModal('plan-outfit-modal');
}

window.toggleOutfitItem = function(day, itemId) {
    if (!state.wardrobe.outfits[day]) {
        state.wardrobe.outfits[day] = [];
    }
    const index = state.wardrobe.outfits[day].indexOf(itemId);
    if (index > -1) {
        state.wardrobe.outfits[day].splice(index, 1); // Quitar si ya está
    } else {
        state.wardrobe.outfits[day].push(itemId); // Añadir si no está
    }
    saveState();
    renderWardrobe(); // Re-renderizar el planificador principal
    // También actualizar la visualización del modal
    window.openOutfitPlanner(day); // Re-renderizar el modal para actualizar selección
}

window.clearOutfit = function(day) {
    state.wardrobe.outfits[day] = [];
    saveState();
    renderWardrobe();
}

document.addEventListener('DOMContentLoaded', () => {
    loadState();
    updateMusicSource();
    render();
    showTab('misiones'); // Mostrar la pestaña de misiones por defecto y activar el icono

    DOM.musicToggleBtn.addEventListener('click', toggleMusic);
    DOM.musicUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        handleFileUpload(file, (data) => {
            state.audio.music = data;
            state.audio.musicFileName = file.name;
            saveState();
            updateMusicSource();
            DOM.bgMusic.play(); 
            const icon = DOM.musicToggleBtn.querySelector('i');
            icon.setAttribute('data-lucide', 'volume-2');
            lucide.createIcons();
            renderAjustes();
        });
    });
    DOM.avatarUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        handleFileUpload(file, (data) => {
            state.character.avatar = data;
            saveState();
            renderCharacter();
        });
    });
    document.body.addEventListener('click', function(e) {
        if (e.target.closest('.sfx-click')) { playSound(SFX_CLICK_URL); }
    });
});
</script>
</body>
</html>
