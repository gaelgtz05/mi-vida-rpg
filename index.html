<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Vida RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-color: #0d1117; --main-color: #161b22; --border-color: #30363d;
            --text-color: #c9d1d9; --text-accent-color: #f0f6fc; --accent-color: #388bfd;
            --xp-color: #388bfd; --success-color: #238636; --danger-color: #da3633;
            --warning-color: #f5a623;
            --nav-height: 70px;
        }
        body { 
            font-family: 'Press Start 2P', cursive; background-color: var(--bg-color); color: var(--text-color); 
            text-shadow: 2px 2px #00000060; image-rendering: pixelated; padding-bottom: var(--nav-height); 
        }
        .pixel-box { background-color: var(--main-color); border: 4px solid var(--border-color); box-shadow: 6px 6px 0px #000000; padding: 1.5rem; }
        .pixel-button { background-color: var(--accent-color); border: 4px solid var(--border-color); box-shadow: 4px 4px 0px #000000; padding: 0.75rem 1rem; color: var(--text-accent-color); text-transform: uppercase; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; }
        .pixel-button:hover { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #000000; }
        .pixel-button.green { background-color: var(--success-color); } .pixel-button.red { background-color: var(--danger-color); }
        .pixel-button.yellow { background-color: var(--warning-color); color: #000; } .pixel-button.gray { background-color: #484f58; }
        input, textarea, select { font-family: 'Press Start 2P', cursive; background-color: var(--bg-color); border: 4px solid var(--border-color); padding: 0.75rem; color: var(--text-color); width: 100%; }
        select { appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23c9d1d9%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; padding-right: 2.5rem; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-color); }
        .progress-bar-container { background-color: var(--bg-color); border: 2px solid var(--border-color); padding: 4px; }
        .progress-bar { height: 20px; }
        .modal-backdrop { background-color: rgba(0,0,0,0.8); transition: opacity 0.2s; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        ::-webkit-scrollbar { width: 16px; } ::-webkit-scrollbar-track { background: var(--bg-color); border-left: 4px solid var(--border-color); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border: 4px solid var(--main-color); }
        .pixel-checkbox { appearance: none; width: 24px; height: 24px; background-color: var(--bg-color); border: 3px solid var(--border-color); cursor: pointer; position: relative; margin-right: 0.75rem; flex-shrink: 0; }
        .pixel-checkbox:checked { background-color: var(--accent-color); border-color: var(--text-accent-color); }
        .pixel-checkbox:checked::after { content: 'X'; color: var(--text-accent-color); position: absolute; font-size: 14px; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .carousel-wrapper { position: relative; }
        .carousel-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .carousel-container::-webkit-scrollbar { display: none; }
        .carousel-slide { flex: 0 0 80%; scroll-snap-align: center; margin: 0 10px; }
        @media (min-width: 768px) { .carousel-slide { flex-basis: 40%; } } @media (min-width: 1024px) { .carousel-slide { flex-basis: 30%; } }
        .carousel-nav { display: none; position: absolute; top: 40%; transform: translateY(-50%); width: 100%; justify-content: space-between; pointer-events: none; }
        @media (min-width: 768px) { .carousel-nav { display: flex; } }
        .nav-arrow { pointer-events: all; background-color: rgba(22, 27, 34, 0.7); border: 2px solid var(--border-color); border-radius: 50%; padding: 0.5rem; }
        .item-image { width: 100%; height: 180px; object-fit: contain; background-color: transparent; border: none; transition: filter 0.3s ease-in-out; }
        .item-image.locked { filter: grayscale(1) opacity(0.5); }
        .lock-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; color: var(--text-accent-color); text-shadow: 3px 3px 0px #000; pointer-events: none; }
        input[type="file"] { border: none; padding: 0; }
        input[type="file"]::file-selector-button { font-family: 'Press Start 2P'; background-color: var(--accent-color); border: 2px solid var(--border-color); padding: 0.5rem; color: var(--text-accent-color); cursor: pointer; }
        .item-card-minimal { display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; padding: 1rem 0; }
        .item-card-minimal .item-name { margin-top: 0.5rem; font-size: 0.9rem; }
        .item-card-minimal .item-price { font-size: 0.8rem; }
        .financial-tag { font-size: 0.6rem; padding: 2px 6px; border: 2px solid; margin-bottom: 0.5rem; }
        #character-avatar { width: 80px; height: 80px; border-radius: 0; border: 4px solid var(--border-color); object-fit: cover; background-color: var(--bg-color); cursor: pointer; transition: transform 0.2s; }
        #character-avatar:hover { transform: scale(1.1); }
        #bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background-color: var(--main-color); border-top: 4px solid var(--border-color); box-shadow: 0 -6px 0px #000000; display: flex; justify-content: space-around; align-items: stretch; padding: 0; z-index: 1000; }
        .nav-icon-button { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-color); font-size: 0.65rem; cursor: pointer; padding: 5px 0; gap: 4px; transition: all 0.2s; text-shadow: none; border: 4px solid transparent; }
        .nav-icon-button.active { background-color: var(--bg-color); border-top: 4px solid var(--accent-color); color: var(--accent-color); }
        .nav-icon-button:hover:not(.active) { background-color: rgba(255,255,255,0.1); }
        .nav-icon-button i { width: 28px; height: 28px; stroke-width: 2.5; }
        .nav-icon-button.active i { stroke: var(--accent-color); }
        main { padding-bottom: 20px; }
        .filter-dropdown { position: relative; }
        .filter-dropdown-button { background-color: var(--bg-color); border: 2px solid var(--border-color); padding: 4px 8px; font-size: 0.7rem; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .filter-dropdown-list { position: absolute; top: 100%; left: 0; right: 0; background-color: var(--main-color); border: 2px solid var(--border-color); z-index: 10; max-height: 200px; overflow-y: auto; }
        .filter-option { padding: 8px; font-size: 0.7rem; cursor: pointer; }
        .filter-option:hover { background-color: var(--accent-color); color: var(--text-accent-color); }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto max-w-5xl">
        <header class="pixel-box mb-8">
            <h1 class="text-2xl md:text-3xl text-text-accent-color text-center mb-4">MI VIDA RPG</h1>
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex items-center gap-4">
                    <label for="avatar-upload" class="cursor-pointer"><img id="character-avatar" src="https://placehold.co/80x80/161b22/c9d1d9?text=?" alt="Avatar"></label>
                    <input type="file" id="avatar-upload" class="hidden" accept="image/png, image/jpeg">
                    <div>
                        <h2 id="character-username" class="text-xl md:text-2xl text-text-accent-color">elgatin</h2>
                        <p class="text-sm text-gray-500">Organizador Personal</p>
                    </div>
                </div>
                <div class="w-full md:w-1/2 space-y-3">
                    <div class="flex items-center gap-2 text-sm"><span class="text-blue-400">PROGRESO:</span><div class="progress-bar-container w-full"><div id="xp-bar" class="progress-bar bg-blue-500"></div></div><span id="xp-text">0%</span></div>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="text-center"><span class="text-green-400">EFECTIVO:</span><div id="cash-balance" class="font-bold">$0.00</div></div>
                        <div class="text-center"><span class="text-cyan-400">TARJETA:</span><div id="card-balance" class="font-bold">$0.00</div></div>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <div id="misiones-tab" class="tab-content active"><div class="pixel-box"><h2 class="text-xl mb-4 text-center">MISIONES DIARIAS</h2><div id="mission-list" class="space-y-4 mb-6 max-h-96 overflow-y-auto p-2"></div><div class="flex flex-col md:flex-row gap-4"><input type="text" id="new-mission-input" placeholder="Nueva misión..."><button class="pixel-button" onclick="addMission()">Aceptar</button></div></div></div>
            <div id="finanzas-tab" class="tab-content"><div class="pixel-box"><h2 class="text-xl mb-4 text-center">LIBRO DE CUENTAS</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><button class="pixel-button green" onclick="openModal('income-modal')">+ Ingreso</button><button class="pixel-button red" onclick="openModal('expense-modal')">- Egreso</button></div><h3 class="text-lg mb-2">Historial:</h3><div id="transaction-filters" class="filter-dropdown mb-4"></div><div id="transaction-list" class="space-y-3 text-sm max-h-80 overflow-y-auto border-2 border-dashed border-gray-600 p-2"></div></div></div>
            <div id="tienda-tab" class="tab-content"><div class="pixel-box"><h2 class="text-xl mb-4 text-center">TIENDA DE DESEOS</h2><div class="carousel-wrapper"><div id="store-carousel" class="carousel-container"></div><div class="carousel-nav"><button class="nav-arrow" onclick="slideStore(-1)"><i data-lucide="arrow-left"></i></button><button class="nav-arrow" onclick="slideStore(1)"><i data-lucide="arrow-right"></i></button></div></div><button class="pixel-button w-full mt-6" onclick="openModal('new-item-modal')">Añadir Objeto</button></div></div>
            <div id="inventario-tab" class="tab-content"><div class="pixel-box"><h2 class="text-xl mb-4 text-center">INVENTARIO</h2><div id="inventory-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-96 overflow-y-auto p-2"></div></div></div>
            <div id="armario-tab" class="tab-content"><div class="pixel-box"><h2 class="text-xl mb-6 text-center">GUARDARROPA</h2><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1"><h3 class="text-lg mb-4">Planificador</h3><div id="weekly-planner" class="space-y-3"></div></div><div class="lg:col-span-2"><h3 class="text-lg mb-4">Mi Inventario</h3><div id="wardrobe-inventory" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[400px] overflow-y-auto border-2 border-dashed border-gray-600 p-2"></div><button class="pixel-button w-full mt-4" onclick="openModal('add-clothing-modal')">Añadir Prenda</button></div></div></div></div>
            <div id="ahorro-tab" class="tab-content"><div class="pixel-box text-center"><h2 class="text-xl mb-4 text-text-accent-color">MI AHORRO</h2><div class="bg-gray-900 p-6 border-4 border-dashed border-gray-600"><p class="text-lg mb-2 text-green-400">Total Ahorrado:</p><p id="savings-balance" class="text-4xl font-bold text-green-300">$0.00</p></div></div></div>
        </main>
    </div>
    
    <div id="income-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50 hidden"><div class="pixel-box w-full max-w-md"><h3 class="text-lg mb-4">Registrar Ingreso</h3><input type="number" id="income-amount" placeholder="Monto ($)" class="mb-3"><input type="text" id="income-source" placeholder="Origen" class="mb-3"><select id="income-account" class="mb-4"><option value="card">Tarjeta</option><option value="cash">Efectivo</option></select><div class="flex justify-end gap-3"><button class="pixel-button gray" onclick="closeModal('income-modal')">Cerrar</button><button class="pixel-button green" onclick="addTransaction('income')">Registrar</button></div></div></div>
    <div id="expense-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50 hidden"><div class="pixel-box w-full max-w-md"><h3 class="text-lg mb-4">Registrar Egreso</h3><input type="number" id="expense-amount" placeholder="Monto ($)" class="mb-3"><select id="expense-account" class="mb-3"><option value="card">Tarjeta</option><option value="cash">Efectivo</option></select><select id="expense-category" class="mb-3"><option value="Comida">Comida</option><option value="Ropa">Ropa</option><option value="Gasolina">Gasolina</option><option value="Suscripciones">Suscripciones</option><option value="Transporte">Transporte</option><option value="Hogar">Hogar</option><option value="Salud">Salud</option><option value="Entretenimiento">Entretenimiento</option><option value="Otro">Otro</option></select><input type="text" id="expense-other-description" placeholder="Descripción específica" class="mb-4 hidden"><div class="flex justify-end gap-3"><button class="pixel-button gray" onclick="closeModal('expense-modal')">Cerrar</button><button class="pixel-button red" onclick="addTransaction('expense')">Registrar</button></div></div></div>
    <div id="new-item-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50 hidden"><div class="pixel-box w-full max-w-md"><h3 class="text-lg mb-4">Nuevo Objeto</h3><input type="text" id="item-name" placeholder="Nombre" class="mb-3"><input type="number" id="item-price" placeholder="Precio ($)" class="mb-3"><label class="text-sm mb-2 block">Imagen (PNG, JPG):</label><input type="file" id="item-image-upload" accept="image/png, image/jpeg" class="mb-4"><div class="flex justify-end gap-3"><button class="pixel-button gray" onclick="closeModal('new-item-modal')">Cerrar</button><button class="pixel-button" onclick="addStoreItem()">Añadir</button></div></div></div>
    <div id="confirm-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50 hidden"><div class="pixel-box w-full max-w-md text-center"><h3 id="confirm-title" class="text-lg mb-4"></h3><p id="confirm-message" class="mb-6"></p><div class="flex justify-center gap-4"><button id="confirm-cancel-btn" class="pixel-button gray">Cancelar</button><button id="confirm-ok-btn" class="pixel-button">Confirmar</button></div></div></div>
    <div id="add-clothing-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50 hidden"><div class="pixel-box w-full max-w-md"><h3 class="text-lg mb-4">Añadir Prenda</h3><input type="text" id="clothing-name" placeholder="Nombre" class="mb-3"><label class="text-sm mb-2 block">Imagen (PNG, JPG):</label><input type="file" id="clothing-image-upload" accept="image/png, image/jpeg" class="mb-4"><div class="flex justify-end gap-3"><button class="pixel-button gray" onclick="closeModal('add-clothing-modal')">Cerrar</button><button class="pixel-button" onclick="addWardrobeItem()">Añadir</button></div></div></div>
    <div id="plan-outfit-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 z-50 hidden"><div class="pixel-box w-full max-w-2xl"><h3 class="text-lg mb-4" id="plan-outfit-title">Planificar Outfit</h3><div id="plan-outfit-inventory" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4 max-h-80 overflow-y-auto border-2 border-dashed border-gray-600 p-2 mb-4"></div><div class="flex justify-end gap-3"><button class="pixel-button gray" onclick="closeModal('plan-outfit-modal')">Cerrar</button></div></div></div>

    <nav id="bottom-nav">
        <button class="nav-icon-button active" onclick="showTab('misiones')" title="Misiones"><i data-lucide="clipboard-check"></i></button>
        <button class="nav-icon-button" onclick="showTab('finanzas')" title="Finanzas"><i data-lucide="wallet"></i></button>
        <button class="nav-icon-button" onclick="showTab('tienda')" title="Tienda"><i data-lucide="shopping-bag"></i></button>
        <button class="nav-icon-button" onclick="showTab('inventario')" title="Inventario"><i data-lucide="archive"></i></button>
        <button class="nav-icon-button" onclick="showTab('armario')" title="Armario"><i data-lucide="shirt"></i></button>
        <button class="nav-icon-button" onclick="showTab('ahorro')" title="Ahorro"><i data-lucide="piggy-bank"></i></button>
    </nav>

<script>
const initialState = { 
    balance: { cash: 0, card: 0 }, 
    savingsBalance: 0, missions: [], transactions: [], storeItems: [], 
    wardrobe: { clothes: [], outfits: {} },
    character: { username: "elgatin", avatar: null },
    financialFilter: 'Todos'
};
let state = { ...initialState };

const DOM = { 
    xpBar: document.getElementById('xp-bar'), xpText: document.getElementById('xp-text'), 
    cashBalance: document.getElementById('cash-balance'), cardBalance: document.getElementById('card-balance'), 
    savingsBalance: document.getElementById('savings-balance'),
    missionList: document.getElementById('mission-list'), 
    transactionList: document.getElementById('transaction-list'), transactionFilters: document.getElementById('transaction-filters'),
    storeCarousel: document.getElementById('store-carousel'), inventoryList: document.getElementById('inventory-list'), 
    wardrobeInventory: document.getElementById('wardrobe-inventory'), weeklyPlanner: document.getElementById('weekly-planner'), 
    confirmModal: { el: document.getElementById('confirm-modal'), title: document.getElementById('confirm-title'), message: document.getElementById('confirm-message'), okBtn: document.getElementById('confirm-ok-btn'), cancelBtn: document.getElementById('confirm-cancel-btn') },
    characterAvatar: document.getElementById('character-avatar'), avatarUpload: document.getElementById('avatar-upload'), characterUsername: document.getElementById('character-username'),
    bottomNav: document.getElementById('bottom-nav'),
    expenseCategory: document.getElementById('expense-category'), expenseOtherDescription: document.getElementById('expense-other-description')
};

const INGRESOS = { SENCILLO: 350, AVANZADO: 550 };
const UMBRAL_COMPRA_GRANDE = 0.30;
const AHORRO_PORCENTAJE = 0.20;
const CATEGORIAS_EGRESO = ['Comida', 'Ropa', 'Gasolina', 'Suscripciones', 'Transporte', 'Hogar', 'Salud', 'Entretenimiento', 'Otro'];

// ==================================================================
// == NUEVAS FUNCIONES DE GUARDADO Y CARGA - ¡LA SOLUCIÓN! ==
// ==================================================================

function saveState() {
    try {
        localStorage.setItem('miVidaRpgState_v23_final', JSON.stringify(state));
    } catch (e) {
        console.error("Error al guardar estado:", e);
        // Esta alerta te avisará si el navegador bloquea el guardado.
        alert("¡Atención! No se pudo guardar tu progreso. El navegador está bloqueando el guardado. Esto es común en Safari al abrir un archivo local. Intenta usar un servicio como CodePen para que funcione correctamente.");
    }
}

function loadState() {
    const s = localStorage.getItem('miVidaRpgState_v23_final');
    if(s){
        try {
            let loadedState = JSON.parse(s);
            state = { ...initialState, ...loadedState };
        } catch(e) {
            console.error("Error al cargar estado, se usará estado inicial.", e);
            // Esta alerta te avisará si los datos guardados están dañados.
            alert("¡Atención! Se encontró un error en tus datos guardados. Se reiniciará el progreso para evitar problemas.");
            state = { ...initialState };
        }
    } else {
        state = { ...initialState };
    }
}

// ==================================================================
// == EL RESTO DEL CÓDIGO PERMANECE IGUAL ==
// ==================================================================

function render() { renderCharacter(); renderStats(); renderMissions(); renderTransactions(); renderStore(); renderInventory(); renderWardrobe(); renderAhorro(); lucide.createIcons(); }
function renderCharacter() { DOM.characterUsername.textContent = state.character.username; DOM.characterAvatar.src = state.character.avatar || "https://placehold.co/80x80/161b22/c9d1d9?text=?"; }
function renderStats() { DOM.cashBalance.textContent = `$${state.balance.cash.toFixed(2)}`; DOM.cardBalance.textContent = `$${state.balance.card.toFixed(2)}`; updateXpBar(); }
function updateXpBar() { const total=state.missions.length; const completed=state.missions.filter(m=>m.completed).length; const perc=total===0?0:Math.round((completed/total)*100); DOM.xpBar.style.width=`${perc}%`; DOM.xpText.textContent=`${perc}%`; }
function renderMissions() { DOM.missionList.innerHTML = state.missions.length === 0 ? '<p class="text-center opacity-50">No hay misiones.</p>' : state.missions.map((m, i) => `<div class="p-3 border-2 ${m.completed?'border-gray-600 opacity-50':'border-gray-400'} flex items-center"><input type="checkbox" id="mission-${i}" class="pixel-checkbox" onchange="toggleMission(${i})" ${m.completed?'checked':''}><label for="mission-${i}" class="${m.completed?'line-through':''}">${m.text}</label></div>`).join(''); }
function renderTransactions() {
    const filters = ['Todos', 'Ingresos', ...CATEGORIAS_EGRESO];
    DOM.transactionFilters.innerHTML = `<button class="filter-dropdown-button" onclick="toggleFilterDropdown()"><span>${state.financialFilter}</span><i data-lucide="chevron-down" class="w-4 h-4"></i></button><div id="filter-list" class="filter-dropdown-list hidden">${filters.map(f => `<div class="filter-option" onclick="setFinancialFilter('${f}')">${f}</div>`).join('')}</div>`;
    let filteredTransactions = state.transactions;
    if (state.financialFilter === 'Ingresos') { filteredTransactions = state.transactions.filter(t => t.type === 'income'); } 
    else if (state.financialFilter !== 'Todos') { filteredTransactions = state.transactions.filter(t => t.category === state.financialFilter); }
    DOM.transactionList.innerHTML = filteredTransactions.length === 0 ? '<p class="text-center opacity-50">Sin transacciones.</p>' : [...filteredTransactions].reverse().map(tx => {
        const isIncome = tx.type === 'income';
        const accountLabel = tx.account === 'cash' ? '[Efectivo]' : '[Tarjeta]';
        const description = isIncome ? tx.description : `${tx.category}${tx.description ? ` (${tx.description})` : ''}`;
        return `<div class="p-2 border-b-2 border-dashed border-gray-700"><div class="flex justify-between items-center"><span>${description} <span class="opacity-60 text-xs">${accountLabel}</span></span><span class="font-bold ${isIncome?'text-green-400':'text-red-400'}">${isIncome?'+':'-'}$${tx.amount.toFixed(2)}</span></div><div class="text-xs opacity-60 text-right">${tx.date}</div></div>`;
    }).join('');
    lucide.createIcons();
}
function renderStore() {
    const unpurchasedItems = state.storeItems.filter(item => !item.purchased);
    const lockSVG = `<svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>`;
    DOM.storeCarousel.innerHTML = unpurchasedItems.length === 0 ? '<p class="text-center opacity-50 w-full">¡Has comprado todo!</p>' : unpurchasedItems.map((item) => {
        const isLocked = !item.purchased;
        const originalIndex = state.storeItems.findIndex(i => i.id === item.id);
        const imageUrl = item.imageData || `data:image/svg+xml,...`;
        let financialTag = '';
        if (item.price < INGRESOS.SENCILLO) { financialTag = `<span class="financial-tag" style="color: var(--success-color); border-color: var(--success-color);">Compra Fácil</span>`; }
        else if (item.price <= INGRESOS.AVANZADO) { financialTag = `<span class="financial-tag" style="color: var(--accent-color); border-color: var(--accent-color);">Meta Alcanzable</span>`; }
        else { financialTag = `<span class="financial-tag" style="color: var(--warning-color); border-color: var(--warning-color);">Gran Inversión</span>`; }
        return `<div class="carousel-slide item-card-minimal"><div class="relative w-full mb-2"><img src="${imageUrl}" alt="${item.name}" class="item-image ${isLocked ? 'locked' : ''}">${isLocked ? `<div class="lock-overlay">${lockSVG}</div>` : ''}</div><h4 class="item-name text-text-accent-color truncate">${item.name}</h4><p class="item-price text-green-400 mb-2">$${item.price.toFixed(2)}</p>${financialTag}<button class="pixel-button" onclick="confirmPurchase(${originalIndex})">Comprar</button></div>`;
    }).join('');
    DOM.storeCarousel.scrollLeft = 0;
}
function renderInventory() { const purchasedItems = state.storeItems.filter(item => item.purchased); DOM.inventoryList.innerHTML = purchasedItems.length === 0 ? '<p class="text-center opacity-50 col-span-full">Aún no tienes objetos.</p>' : purchasedItems.map(item => `<div class="item-card-minimal"><img src="${item.imageData}" alt="${item.name}" class="item-image mb-2"><h4 class="item-name text-text-accent-color truncate">${item.name}</h4></div>`).join(''); }
function renderWardrobe() {
    DOM.wardrobeInventory.innerHTML = !state.wardrobe.clothes || state.wardrobe.clothes.length === 0 ? '<p class="text-center opacity-50 col-span-full">Armario vacío.</p>' : state.wardrobe.clothes.map(item => `<div class="relative group item-card-minimal"><img src="${item.imageData}" alt="${item.name}" class="item-image !h-24"><p class="text-xs truncate">${item.name}</p><button onclick="removeWardrobeItem('${item.id}')" class="absolute top-0 right-0 p-1 bg-danger-color/50 rounded-full hidden group-hover:block"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join('');
}
function renderAhorro() { DOM.savingsBalance.textContent = `$${state.savingsBalance.toFixed(2)}`; }
function handleFileUpload(file, callback) { if(!file)return; if(file.size>10*1024*1024){alert("Error: Archivo muy grande (máx 10MB)");return;} const r=new FileReader(); r.onload=(e)=>{callback(e.target.result);}; r.readAsDataURL(file); }

window.addMission = function() { const i=document.getElementById('new-mission-input'); const t=i.value.trim(); if(t){state.missions.push({text:t,completed:false});i.value='';saveState();render();} }
window.toggleMission = function(index) { state.missions[index].completed = !state.missions[index].completed; saveState();render(); }
window.addTransaction = function(type) {
    const amountEl = document.getElementById(`${type}-amount`); const amount = parseFloat(amountEl.value);
    if (!amount || amount <= 0) return;
    if (type === 'income') {
        const sourceEl = document.getElementById('income-source'); const account = document.getElementById('income-account').value; const source = sourceEl.value.trim();
        if (!source) return;
        const savings = amount * AHORRO_PORCENTAJE;
        state.savingsBalance += savings;
        state.balance[account] += (amount - savings);
        state.transactions.push({ type: 'income', amount, description: source, date: new Date().toLocaleDateString('es-MX'), account });
        sourceEl.value = '';
    } else {
        const account = document.getElementById('expense-account').value;
        if (amount > state.balance[account]) { alert(`Saldo insuficiente en ${account}.`); return; }
        const category = DOM.expenseCategory.value;
        let description = null;
        if (category === 'Otro') {
            description = DOM.expenseOtherDescription.value.trim();
            if (!description) { alert('Por favor, especifica el gasto.'); return; }
        }
        state.balance[account] -= amount;
        state.transactions.push({ type: 'expense', amount, category, description, date: new Date().toLocaleDateString('es-MX'), account });
        DOM.expenseOtherDescription.value = ''; DOM.expenseOtherDescription.classList.add('hidden'); DOM.expenseCategory.value = 'Comida';
    }
    amountEl.value = ''; closeModal(`${type}-modal`); saveState(); render();
}
window.addStoreItem = function() { const nEl=document.getElementById('item-name'), pEl=document.getElementById('item-price'), iEl=document.getElementById('item-image-upload'); const n=nEl.value.trim(), p=parseFloat(pEl.value), f=iEl.files[0]; if(!n||!p||p<=0)return; const process=(d)=>{state.storeItems.push({id:`item_${Date.now()}`,name:n,price:p,imageData:d,purchased:false});nEl.value='';pEl.value='';iEl.value='';closeModal('new-item-modal');saveState();render();}; if(f){const r=new FileReader();r.onload=(e)=>process(e.target.result);r.readAsDataURL(f);}else{process(null);} }
window.addWardrobeItem = function() { const nEl = document.getElementById('clothing-name'); const iEl = document.getElementById('clothing-image-upload'); const n = nEl.value.trim(); const f = iEl.files[0]; if (!n || !f) { alert("Añade nombre e imagen."); return; } handleFileUpload(f, (data) => { if(!state.wardrobe.clothes) state.wardrobe.clothes = []; state.wardrobe.clothes.push({ id: `cloth_${Date.now()}`, name: n, imageData: data }); nEl.value = ''; iEl.value = ''; closeModal('add-clothing-modal'); saveState(); render(); }); }
window.removeWardrobeItem = function(id) { state.wardrobe.clothes = state.wardrobe.clothes.filter(i => i.id !== id); saveState(); render(); }
window.confirmPurchase = function(index) {
    const item = state.storeItems[index];
    if (item.purchased || (state.balance.cash + state.balance.card) < item.price) { alert('Saldo insuficiente.'); return; }
    const isRisky = item.price > ((state.balance.cash + state.balance.card) * UMBRAL_COMPRA_GRANDE);
    let title = 'Confirmar Compra', message = `¿Seguro que quieres comprar "${item.name}"?`, btnClass = 'green';
    if (isRisky) { title = '¡Compra Grande!'; message = `¡Cuidado! Usarás más del ${UMBRAL_COMPRA_GRANDE*100}% de tu saldo total. ¿Seguro?`; btnClass = 'yellow'; }
    showConfirmation(title, message, btnClass, () => buyStoreItem(index));
}
function buyStoreItem(index) { 
    const item = state.storeItems[index];
    if (state.balance.card >= item.price) { state.balance.card -= item.price; } 
    else { const remaining = item.price - state.balance.card; state.balance.card = 0; state.balance.cash -= remaining; }
    item.purchased = true; saveState(); render(); 
}
function showConfirmation(title, message, btnClass, callback) {
    DOM.confirmModal.title.textContent = title; DOM.confirmModal.message.textContent = message;
    DOM.confirmModal.okBtn.className = `pixel-button ${btnClass}`;
    const newOkBtn = DOM.confirmModal.okBtn.cloneNode(true);
    DOM.confirmModal.okBtn.parentNode.replaceChild(newOkBtn, DOM.confirmModal.okBtn);
    DOM.confirmModal.okBtn = newOkBtn;
    DOM.confirmModal.okBtn.addEventListener('click', () => { callback(); closeModal('confirm-modal'); });
    DOM.confirmModal.cancelBtn.onclick = () => closeModal('confirm-modal');
    openModal('confirm-modal');
}
window.showTab = function(tabId) { document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.nav-icon-button').forEach(b=>b.classList.remove('active')); document.getElementById(`${tabId}-tab`).classList.add('active'); const targetButton=DOM.bottomNav.querySelector(`[onclick="showTab('${tabId}')"]`); if(targetButton)targetButton.classList.add('active'); }
window.openModal = function(id) { document.getElementById(id).classList.remove('hidden'); }
window.closeModal = function(id) { document.getElementById(id).classList.add('hidden'); }
window.slideStore = function(dir) { const c=DOM.storeCarousel; const slide=c.querySelector('.carousel-slide'); if(!slide) return; const scrollAmount=slide.offsetWidth+20; c.scrollBy({left:scrollAmount*dir,behavior:'smooth'}); }
window.setFinancialFilter = function(filter) { state.financialFilter = filter; render(); const filterList = document.getElementById('filter-list'); if (filterList) filterList.classList.add('hidden'); }
window.toggleFilterDropdown = function() { const filterList = document.getElementById('filter-list'); if (filterList) filterList.classList.toggle('hidden'); }
window.openOutfitPlanner = function(day) { /* ...código de planificador... */ };
window.toggleOutfitItem = function(day, itemId) { /* ...código de planificador... */ };
window.clearOutfit = function(day) { /* ...código de planificador... */ };

document.addEventListener('DOMContentLoaded', () => {
    loadState();
    render();
    showTab('misiones');
    
    DOM.avatarUpload.addEventListener('change', (e) => { handleFileUpload(e.target.files[0], (data) => { state.character.avatar = data; saveState(); renderCharacter(); }); });
    DOM.expenseCategory.addEventListener('change', (e) => { if (e.target.value === 'Otro') { DOM.expenseOtherDescription.classList.remove('hidden'); } else { DOM.expenseOtherDescription.classList.add('hidden'); } });
});
</script>
</body>
</html>
